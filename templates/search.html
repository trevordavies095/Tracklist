{% extends "base.html" %}

{% block title %}Search Albums - Tracklist{% endblock %}

{% block nav_search %}text-blue-600 border-b-2 border-blue-600{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-primary mb-4">Find Albums to Rate</h1>
        <p class="text-lg text-secondary max-w-2xl mx-auto">
            Search for albums from the MusicBrainz database and start rating them track by track.
        </p>
    </div>
    
    <!-- Search Form -->
    <div class="bg-surface rounded-lg shadow-sm border border-default p-6 mb-8">
        <form class="space-y-4"
              x-data="searchForm()"
              @submit.prevent="submitForm($el)">
            
            <!-- General Search Input -->
            <div class="relative">
                <label for="search-query" class="block text-sm font-medium text-primary mb-2">
                    General Search
                </label>
                <div class="relative">
                    <input type="text" 
                           id="search-query"
                           name="q" 
                           x-model="query"
                           @keyup.debounce.500ms="if (query && !usingAdvanced()) { submitForm($el.form) }"
                           class="search-input block w-full pl-10 pr-3 py-3 border border-default rounded-md leading-5 bg-surface text-primary placeholder-muted focus:outline-none focus:placeholder-secondary focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           placeholder='Try "OK Computer" or "Radiohead"'
                           autocomplete="off">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                <p class="mt-2 text-sm text-muted">
                    Search is powered by MusicBrainz - the open music encyclopedia
                </p>
            </div>
            
            <!-- Advanced Search Options -->
            <details class="cursor-pointer" x-data="{ open: false }" x-model="open">
                <summary class="text-sm font-medium text-primary hover:text-primary py-2">
                    ðŸ”§ Advanced Search Options
                </summary>
                <div class="mt-4 space-y-4 p-4 bg-background rounded-lg">
                    <!-- Structured Search Fields -->
                    <div class="border-b border-default pb-4">
                        <h4 class="text-sm font-semibold text-primary mb-3">Structured Search</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="artist" class="block text-sm font-medium text-primary mb-1">Artist Name</label>
                                <input type="text" 
                                       name="artist" 
                                       id="artist"
                                       x-model="artist"
                                       @input="clearGeneralIfAdvanced()"
                                       class="block w-full rounded-md border-default bg-surface text-primary placeholder-muted shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                       placeholder="e.g., Perfume Genius">
                            </div>
                            <div>
                                <label for="album" class="block text-sm font-medium text-primary mb-1">Album Title</label>
                                <input type="text" 
                                       name="album" 
                                       id="album"
                                       x-model="album"
                                       @input="clearGeneralIfAdvanced()"
                                       class="block w-full rounded-md border-default bg-surface text-primary placeholder-muted shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                       placeholder="e.g., Glory">
                            </div>
                            <div>
                                <label for="year" class="block text-sm font-medium text-primary mb-1">
                                    Release Year
                                    <span class="text-xs text-muted font-normal">(optional)</span>
                                </label>
                                <input type="number" 
                                       name="year" 
                                       id="year"
                                       x-model="year"
                                       @input="clearGeneralIfAdvanced(); validateYear()"
                                       min="1900"
                                       :max="new Date().getFullYear() + 1"
                                       class="block w-full rounded-md border-default bg-surface text-primary placeholder-muted shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                       :class="{'border-red-300': yearError}"
                                       placeholder="e.g., 2020">
                                <p x-show="yearError" x-text="yearError" class="mt-1 text-xs text-red-600"></p>
                                <p x-show="!yearError" class="mt-1 text-xs text-muted">Helps find specific release/reissue</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Direct MusicBrainz ID Lookup -->
                    <div class="border-b border-default pb-4">
                        <h4 class="text-sm font-semibold text-primary mb-3">Direct Album Lookup</h4>
                        <div>
                            <label for="mbid" class="block text-sm font-medium text-primary mb-1">
                                MusicBrainz Release ID
                                <a href="https://musicbrainz.org" target="_blank" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 ml-1">
                                    <svg class="inline-block w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            </label>
                            <input type="text" 
                                   name="mbid" 
                                   id="mbid"
                                   x-model="mbid"
                                   @input="clearOtherFields(); validateMBID()"
                                   class="block w-full rounded-md border-default bg-surface text-primary placeholder-muted shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2 px-3 text-base md:text-sm"
                                   :class="{'border-red-300': mbidError}"
                                   placeholder="e.g., 7f9e8590-5d8f-4234-8b23-5f1234567890"
                                   pattern="[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}">
                            <p x-show="mbidError" x-text="mbidError" class="mt-1 text-xs text-red-600"></p>
                            <p x-show="!mbidError" class="mt-1 text-xs text-muted">36-character UUID for direct album lookup</p>
                        </div>
                    </div>
                    
                    <!-- Search Settings -->
                    <div>
                        <h4 class="text-sm font-semibold text-primary mb-3">Display Settings</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                            <div>
                                <label for="limit" class="block text-sm font-medium text-primary mb-1">Results per page</label>
                                <select name="limit" id="limit" class="block w-full rounded-md border-default bg-surface text-primary shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2 px-3 text-base md:text-sm">
                                    <option value="10">10 results</option>
                                    <option value="25" selected>25 results</option>
                                    <option value="50">50 results</option>
                                </select>
                            </div>
                            <div>
                                <label for="offset" class="block text-sm font-medium text-primary mb-1">Start from result</label>
                                <input type="number" name="offset" id="offset" value="0" min="0" step="10"
                                       class="block w-full rounded-md border-default bg-surface text-primary shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2 px-3 text-base md:text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            </details>
            
            <!-- Search Button -->
            <div class="flex justify-center">
                <button type="submit" 
                        :disabled="cannotSearch()"
                        class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-muted disabled:cursor-not-allowed transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Search Albums
                </button>
            </div>
        </form>
    </div>
    
    <!-- Search Loading -->
    <div id="search-loading" class="htmx-indicator">
        <div class="text-center py-8">
            <div class="inline-flex items-center px-4 py-2 bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-900/50 rounded-lg text-blue-800 dark:text-blue-400">
                <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Searching MusicBrainz...
            </div>
        </div>
    </div>
    
    <!-- Search Results -->
    <div id="search-results">
        <!-- Results will be loaded here via HTMX -->
        <div class="text-center py-12 text-secondary">
            <svg class="w-16 h-16 mx-auto mb-4 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <p class="text-lg">Start typing to search for albums...</p>
            <p class="text-sm mt-2">We'll search the MusicBrainz database for you</p>
        </div>
    </div>
    
    <!-- Search Tips -->
    <div class="mt-12 bg-background rounded-lg p-6">
        <h3 class="text-lg font-semibold text-primary mb-4">ðŸ’¡ Search Tips</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-medium text-primary mb-2">What you can search for:</h4>
                <ul class="text-sm text-secondary space-y-1">
                    <li>â€¢ Album titles: "OK Computer", "Abbey Road"</li>
                    <li>â€¢ Artist names: "Radiohead", "The Beatles"</li>
                    <li>â€¢ Combined: "Radiohead OK Computer"</li>
                    <li>â€¢ Partial matches work too!</li>
                </ul>
            </div>
            <div>
                <h4 class="font-medium text-primary mb-2">Getting better results:</h4>
                <ul class="text-sm text-secondary space-y-1">
                    <li>â€¢ Use specific album names when possible</li>
                    <li>â€¢ Try different variations if not found</li>
                    <li>â€¢ Check spelling and try shorter terms</li>
                    <li>â€¢ Use the MusicBrainz link to verify</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Alpine.js component for search form
function searchForm() {
    return {
        query: '',
        artist: '',
        album: '',
        year: '',
        mbid: '',
        yearError: '',
        mbidError: '',
        
        init() {
            // Focus on search input when page loads
            this.$nextTick(() => {
                document.getElementById('search-query').focus();
            });
        },
        
        usingAdvanced() {
            return this.artist || this.album || this.year || this.mbid;
        },
        
        clearGeneralIfAdvanced() {
            if (this.artist || this.album || this.year) {
                this.query = '';
                this.mbid = '';
                this.mbidError = '';
            }
        },
        
        clearOtherFields() {
            if (this.mbid) {
                this.query = '';
                this.artist = '';
                this.album = '';
                this.year = '';
                this.yearError = '';
            }
        },
        
        validateYear() {
            this.yearError = ''; // Clear error first
            if (this.year && this.year !== '') {
                const yearNum = parseInt(this.year);
                const currentYear = new Date().getFullYear();
                if (isNaN(yearNum)) {
                    this.yearError = 'Please enter a valid year';
                } else if (yearNum < 1900) {
                    this.yearError = 'Year must be 1900 or later';
                } else if (yearNum > currentYear + 1) {
                    this.yearError = `Year cannot be later than ${currentYear + 1}`;
                }
            }
        },
        
        validateMBID() {
            if (this.mbid) {
                const mbidPattern = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i;
                if (!mbidPattern.test(this.mbid)) {
                    this.mbidError = 'Invalid MusicBrainz ID format (must be 36-character UUID)';
                } else {
                    this.mbidError = '';
                }
            } else {
                this.mbidError = '';
            }
        },
        
        cannotSearch() {
            // Check if there are any validation errors
            if (this.yearError || this.mbidError) {
                return true;
            }
            
            // Check if at least one search field has a value
            const hasSearchValue = !!(
                this.query || 
                this.artist || 
                this.album || 
                this.mbid ||
                this.year
            );
            
            return !hasSearchValue;
        },
        
        submitForm(form) {
            // Build URL with only non-empty parameters
            const params = new URLSearchParams();
            
            if (this.query.trim()) params.append('q', this.query.trim());
            if (this.artist.trim()) params.append('artist', this.artist.trim());
            if (this.album.trim()) params.append('album', this.album.trim());
            if (this.year) params.append('year', this.year);
            if (this.mbid.trim()) params.append('mbid', this.mbid.trim());
            
            // Always include limit and offset
            const limit = form.querySelector('[name="limit"]').value;
            const offset = form.querySelector('[name="offset"]').value;
            params.append('limit', limit);
            params.append('offset', offset);
            
            // Trigger HTMX request with clean parameters
            htmx.ajax('GET', `/api/v1/search/albums?${params.toString()}`, {
                target: '#search-results',
                indicator: '#search-loading'
            });
        }
    }
}

// Handle search result interactions
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.target.id === 'search-results') {
        // Scroll to results after search
        document.getElementById('search-results').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
        
        // Initialize true lazy loading after search results are displayed
        initializeArtworkLazyLoading();
    }
});

// True lazy loading with Intersection Observer (iOS compatible)
let artworkObserver = null;
let loadingQueue = new Set();

function initializeArtworkLazyLoading() {
    // Cleanup existing observer
    if (artworkObserver) {
        artworkObserver.disconnect();
    }
    
    // Check for Intersection Observer support (fallback for older iOS)
    if (!('IntersectionObserver' in window)) {
        console.debug('IntersectionObserver not supported, falling back to immediate loading');
        loadArtworkLazily();
        return;
    }
    
    // Create observer with iOS-friendly options
    artworkObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const container = entry.target;
                const mbid = container.dataset.mbid;
                
                // Avoid duplicate loading
                if (loadingQueue.has(mbid)) return;
                loadingQueue.add(mbid);
                
                // Stop observing this element
                artworkObserver.unobserve(container);
                
                // Load the artwork
                loadSingleArtwork(container, mbid);
            }
        });
    }, {
        // More aggressive intersection for iOS
        rootMargin: '50px 0px',
        threshold: 0.1
    });
    
    // Observe all artwork containers
    const artworkContainers = document.querySelectorAll('.album-artwork[data-mbid]');
    artworkContainers.forEach(container => {
        artworkObserver.observe(container);
    });
}

async function loadSingleArtwork(container, mbid) {
    const img = container.querySelector('img');
    const placeholder = container.querySelector('.artwork-placeholder');
    
    try {
        console.debug(`Loading artwork for ${mbid}`);
        
        const response = await fetch(`/api/v1/releases/${mbid}/artwork-url`);
        if (response.ok) {
            const data = await response.json();
            console.debug(`Artwork response for ${mbid}:`, data);
            
            if (data.url && data.url !== null && data.url !== '') {
                console.debug(`Loading artwork for ${mbid}: ${data.url}`);
                
                // Set up image loading with iOS-compatible error handling
                const loadPromise = new Promise((resolve, reject) => {
                    img.onload = function() {
                        console.debug(`Image loaded successfully for ${mbid}`);
                        resolve();
                    };
                    
                    img.onerror = function() {
                        console.debug(`Image failed to load for ${mbid}`);
                        reject(new Error('Image load failed'));
                    };
                    
                    // Timeout for iOS network issues
                    setTimeout(() => {
                        reject(new Error('Image load timeout'));
                    }, 10000);
                    
                    // Start loading
                    img.src = data.url;
                });
                
                try {
                    await loadPromise;
                    // Success - show image with transition
                    img.style.opacity = '0';
                    img.style.transition = 'opacity 0.3s ease-in-out';
                    img.classList.remove('hidden');
                    
                    // Use requestAnimationFrame for smoother iOS transitions
                    requestAnimationFrame(() => {
                        img.style.opacity = '1';
                        placeholder.style.display = 'none';
                    });
                    
                } catch (loadError) {
                    // Image failed to load - keep placeholder
                    handleArtworkError(img, placeholder);
                }
                
            } else {
                console.debug(`No artwork URL for ${mbid}, keeping placeholder`);
                handleArtworkError(img, placeholder);
            }
        } else {
            console.debug(`API call failed for ${mbid}`);
            handleArtworkError(img, placeholder);
        }
    } catch (error) {
        console.debug(`Exception loading artwork for ${mbid}:`, error);
        handleArtworkError(img, placeholder);
    } finally {
        loadingQueue.delete(mbid);
    }
}

function handleArtworkError(img, placeholder) {
    // Clean up image element
    img.onload = null;
    img.onerror = null;
    img.style.transition = '';
    img.style.opacity = '';
    img.classList.add('hidden');
    
    // Show static placeholder (stop shimmer)
    placeholder.style.display = 'flex';
    placeholder.classList.remove('artwork-placeholder');
    placeholder.classList.add('artwork-no-shimmer');
}

// Fallback for browsers without Intersection Observer
async function loadArtworkLazily() {
    const artworkContainers = document.querySelectorAll('.album-artwork[data-mbid]');
    
    // Load artwork with delays, but only load visible items first
    const visibleContainers = Array.from(artworkContainers).filter(container => {
        const rect = container.getBoundingClientRect();
        return rect.top < window.innerHeight + 100; // Load if near viewport
    });
    
    // Load visible items first
    for (let i = 0; i < visibleContainers.length; i++) {
        const container = visibleContainers[i];
        const mbid = container.dataset.mbid;
        
        if (loadingQueue.has(mbid)) continue;
        loadingQueue.add(mbid);
        
        // Stagger requests
        if (i > 0) await new Promise(resolve => setTimeout(resolve, 200));
        
        await loadSingleArtwork(container, mbid);
    }
}
</script>
{% endblock %}