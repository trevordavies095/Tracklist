<!-- Search Results Component -->
<!-- This template is used by HTMX to render search results -->

{% if albums and albums|length > 0 %}
<div class="space-y-4">
    <!-- Search Context Display -->
    {% if search_context %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 text-sm">
        {% if search_context.type == 'direct_lookup' %}
            <span class="text-blue-800">Direct album lookup via MusicBrainz ID</span>
        {% elif search_context.type == 'structured' %}
            <span class="text-blue-800">Showing results for: 
                {% if search_context.artist %}<strong>Artist:</strong> {{ search_context.artist }}{% endif %}
                {% if search_context.artist and search_context.album %}, {% endif %}
                {% if search_context.album %}<strong>Album:</strong> {{ search_context.album }}{% endif %}
                {% if search_context.year %}{% if search_context.artist or search_context.album %}, {% endif %}<strong>Year:</strong> {{ search_context.year }}{% endif %}
            </span>
        {% else %}
            <span class="text-blue-800">General search for: <strong>{{ search_context.query }}</strong></span>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Results Header -->
    <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900">
            Found {{ total }} result{{ 's' if total != 1 else '' }}
        </h3>
        {% if offset > 0 or has_more %}
        <div class="text-sm text-gray-500">
            Showing {{ offset + 1 }}-{{ offset + albums|length }} of {{ total }}
        </div>
        {% endif %}
    </div>
    
    <!-- Album Results -->
    <div class="grid grid-cols-1 gap-4">
        {% for album in albums %}
        <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow duration-200" 
             x-data="{ adding: false, added: false }"
             data-album-id="{{ album.musicbrainz_id }}"
             data-album-title="{{ album.title }}"
             data-album-artist="{{ album.artist }}">
            
            <div class="flex flex-col md:flex-row md:items-start space-y-4 md:space-y-0 md:space-x-6">
                <!-- Album Artwork (Lazy Loaded) -->
                <div class="flex-shrink-0">
                    <div class="album-artwork w-20 h-20 md:w-24 md:h-24 rounded-lg overflow-hidden" data-mbid="{{ album.musicbrainz_id }}">
                        <img class="w-full h-full object-cover hidden" 
                             alt="{{ album.title }} cover" 
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="artwork-placeholder w-20 h-20 md:w-24 md:h-24 bg-gradient-to-br from-gray-200 to-gray-300 rounded-lg flex items-center justify-center">
                            <svg class="w-8 h-8 md:w-10 md:h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Album Details -->
                <div class="flex-1 min-w-0">
                    <h4 class="text-lg font-semibold text-gray-900 mb-1">
                        {{ album.title }}
                        {% if album.year %}
                        <span class="text-sm font-normal text-gray-500">({{ album.year }})</span>
                        {% elif album.date %}
                        <span class="text-sm font-normal text-gray-500">({{ album.date[:4] }})</span>
                        {% endif %}
                    </h4>
                    <p class="text-md text-gray-600 mb-2">{{ album.artist }} • {{ album.track_count if album.track_count else '?' }} tracks</p>
                    
                    <!-- Format and Country in a compact line like the retag modal -->
                    {% if album.media or album.format or album.country %}
                    <p class="text-sm text-gray-500 mb-3">
                        {% if album.media and album.media|length > 0 %}
                            {% set formats = [] %}
                            {% for medium in album.media %}
                                {% if medium.format and medium.format not in formats %}
                                    {% set _ = formats.append(medium.format) %}
                                {% endif %}
                            {% endfor %}
                            {% if formats %}Format: {{ formats|join(', ') }}{% endif %}
                        {% elif album.format %}
                            Format: {{ album.format }}
                        {% endif %}
                        {% if (album.media or album.format) and album.country %} • {% endif %}
                        {% if album.country %}Country: {{ album.country }}{% endif %}
                    </p>
                    {% endif %}
                    
                    <!-- Additional metadata in a more compact format -->
                    {% if album.label %}
                    <div class="text-sm text-gray-500 mb-4">
                        <span>Label: {{ album.label[:30] }}{% if album.label|length > 30 %}...{% endif %}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Tags/Genres -->
                    {% if album.tags and album.tags|length > 0 %}
                    <div class="mb-4">
                        <div class="flex flex-wrap gap-1">
                            {% for tag in album.tags[:5] %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                {{ tag.name }}
                            </span>
                            {% endfor %}
                            {% if album.tags|length > 5 %}
                            <span class="text-xs text-gray-500">+{{ album.tags|length - 5 }} more</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Actions -->
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button @click="adding = true"
                                :disabled="adding || added"
                                class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white transition-colors"
                                :class="added ? 'bg-green-600 cursor-default' : adding ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                                hx-post="/api/v1/albums"
                                hx-vals='{"musicbrainz_id": "{{ album.musicbrainz_id }}"}'
                                hx-target="this"
                                hx-swap="outerHTML"
                                hx-indicator="#loading-indicator">
                            <span x-show="!adding && !added" class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add to Rate
                            </span>
                            <span x-show="adding" class="flex items-center">
                                <svg class="animate-spin w-4 h-4 mr-2" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Adding...
                            </span>
                            <span x-show="added" class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Added
                            </span>
                        </button>
                        
                        <button @click="console.log('Show details for album:', $el.closest('[data-album-title]').dataset.albumTitle)"
                                class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Details
                        </button>
                        
                        <a href="https://musicbrainz.org/release/{{ album.musicbrainz_id }}" 
                           target="_blank"
                           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                            MusicBrainz
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if has_more or offset > 0 %}
    <div class="flex justify-between items-center pt-6 border-t border-gray-200">
        <div class="text-sm text-gray-500">
            {% if offset > 0 %}
            <button hx-get="/api/v1/search/albums?{% if query %}q={{ query }}&{% endif %}{% if artist %}artist={{ artist }}&{% endif %}{% if album %}album={{ album }}&{% endif %}{% if year %}year={{ year }}&{% endif %}{% if mbid %}mbid={{ mbid }}&{% endif %}offset={{ offset - limit }}&limit={{ limit }}"
                    hx-target="#search-results" 
                    hx-indicator="#search-loading"
                    class="text-blue-600 hover:text-blue-800 font-medium">
                ← Previous
            </button>
            {% endif %}
        </div>
        
        <div class="text-sm text-gray-500">
            Page {{ (offset // limit) + 1 }}
        </div>
        
        <div class="text-sm text-gray-500">
            {% if has_more %}
            <button hx-get="/api/v1/search/albums?{% if query %}q={{ query }}&{% endif %}{% if artist %}artist={{ artist }}&{% endif %}{% if album %}album={{ album }}&{% endif %}{% if year %}year={{ year }}&{% endif %}{% if mbid %}mbid={{ mbid }}&{% endif %}offset={{ offset + limit }}&limit={{ limit }}"
                    hx-target="#search-results" 
                    hx-indicator="#search-loading"
                    class="text-blue-600 hover:text-blue-800 font-medium">
                Next →
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>


{% else %}
<!-- No Results -->
<div class="text-center py-12">
    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No albums found</h3>
    <p class="text-gray-600 mb-6">Try different search terms or check the spelling</p>
    
    <div class="max-w-md mx-auto">
        <h4 class="font-medium text-gray-700 mb-2">Try searching for:</h4>
        <div class="text-sm text-gray-600 space-y-1">
            <p>• Full album titles: "OK Computer", "Dark Side of the Moon"</p>
            <p>• Artist names: "Radiohead", "Pink Floyd"</p>
            <p>• Partial matches: "computer", "floyd"</p>
        </div>
    </div>
</div>
{% endif %}