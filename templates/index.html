{% extends "base.html" %}

{% block title %}Dashboard - Tracklist{% endblock %}

{% block nav_home %}text-blue-600 border-b-2 border-blue-600{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Welcome Header -->
    <div class="text-center mb-8 md:mb-12 mobile-compact-header">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-2 md:mb-4">Welcome to Tracklist</h1>
        <p class="text-sm sm:text-base md:text-xl text-gray-600 max-w-3xl mx-auto px-4 md:px-0">
            Your personal music album rating system.
            <span class="hidden sm:inline"> Rate and track your favorite albums with precision.</span>
        </p>
    </div>
    
    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4 md:gap-6 mb-8 md:mb-12 px-4 md:px-0">
        <!-- Search Albums -->
        <a href="/search" class="group block">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 md:p-6 hover:shadow-md hover:border-blue-300 transition-all duration-200 mobile-action-card flex">
                <div class="flex-1">
                    <div class="flex items-center mb-3 md:mb-4">
                        <div class="flex items-center justify-center w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-lg group-hover:bg-blue-200 transition-colors mobile-icon-box">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-1 md:mb-2">Search Albums</h3>
                    <p class="text-xs sm:text-sm md:text-base text-gray-600">Find albums to rate from MusicBrainz</p>
                </div>
                <div class="flex items-center ml-3">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            </div>
        </a>
        
        <!-- My Albums -->
        <a href="/albums" class="group block">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 md:p-6 hover:shadow-md hover:border-green-300 transition-all duration-200 mobile-action-card flex">
                <div class="flex-1">
                    <div class="flex items-center mb-3 md:mb-4">
                        <div class="flex items-center justify-center w-10 h-10 md:w-12 md:h-12 bg-green-100 rounded-lg group-hover:bg-green-200 transition-colors mobile-icon-box">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-1 md:mb-2">My Albums</h3>
                    <p class="text-xs sm:text-sm md:text-base text-gray-600">View and manage your library</p>
                </div>
                <div class="flex items-center ml-3">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-green-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            </div>
        </a>
        
        <!-- Statistics -->
        <a href="/stats" class="group block">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 md:p-6 hover:shadow-md hover:border-purple-300 transition-all duration-200 mobile-action-card flex">
                <div class="flex-1">
                    <div class="flex items-center mb-3 md:mb-4">
                        <div class="flex items-center justify-center w-10 h-10 md:w-12 md:h-12 bg-purple-100 rounded-lg group-hover:bg-purple-200 transition-colors mobile-icon-box">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-1 md:mb-2">Your Stats</h3>
                    <p class="text-xs sm:text-sm md:text-base text-gray-600">View statistics and insights</p>
                </div>
                <div class="flex items-center ml-3">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            </div>
        </a>
    </div>
    
    <!-- In Progress Albums -->
    <div class="mb-8 md:mb-12 mobile-section-spacing px-4 md:px-0" id="in-progress-section">
        <div class="flex justify-between items-center mb-4 md:mb-6 mobile-section-header">
            <h2 class="text-xl md:text-2xl font-bold text-gray-900">In Progress</h2>
            <a href="/albums?filter=in-progress" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View all →</a>
        </div>
        
        <div id="in-progress-albums" 
             hx-get="/api/v1/albums?limit=3&rated=false&sort=created_desc" 
             hx-trigger="load"
             hx-target="this"
             hx-swap="none"
             hx-indicator="#in-progress-loading">
            
            <!-- Loading State -->
            <div id="in-progress-loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6">
                {% for i in range(3) %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 md:p-6 mobile-hide-skeleton">
                    <div class="loading-skeleton h-12 w-12 md:h-20 md:w-20 rounded-lg mb-3 md:mb-4"></div>
                    <div class="loading-skeleton h-4 w-full mb-2"></div>
                    <div class="loading-skeleton h-4 w-3/4 mb-4"></div>
                    <div class="loading-skeleton h-2 w-full"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Recently Rated Albums -->
    <div class="mb-8 md:mb-12 mobile-section-spacing px-4 md:px-0" id="recently-rated-section">
        <div class="flex justify-between items-center mb-4 md:mb-6 mobile-section-header">
            <h2 class="text-xl md:text-2xl font-bold text-gray-900">Recently Rated</h2>
            <a href="/albums?filter=completed" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View all →</a>
        </div>
        
        <div id="recently-rated-albums" 
             hx-get="/api/v1/albums?limit=3&rated=true&sort=rated_desc" 
             hx-trigger="load"
             hx-target="this"
             hx-swap="none"
             hx-indicator="#recently-rated-loading">
            
            <!-- Loading State -->
            <div id="recently-rated-loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6">
                {% for i in range(3) %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 md:p-6 mobile-hide-skeleton">
                    <div class="loading-skeleton h-12 w-12 md:h-20 md:w-20 rounded-lg mb-3 md:mb-4"></div>
                    <div class="loading-skeleton h-4 w-full mb-2"></div>
                    <div class="loading-skeleton h-4 w-3/4 mb-4"></div>
                    <div class="loading-skeleton h-2 w-full"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Getting Started Guide -->
    <div id="getting-started-guide"
         class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-4 sm:p-6 md:p-8 mb-8 md:mb-12 mx-4 md:mx-0" 
         x-data="{ dismissed: localStorage.getItem('guide-dismissed') === 'true' }" 
         x-show="!dismissed"
         style="display: none;">
        
        <div class="flex justify-between items-start mb-4 md:mb-6">
            <div>
                <h3 class="text-lg md:text-xl font-semibold text-blue-900 mb-1 md:mb-2">🚀 Getting Started</h3>
                <p class="text-sm md:text-base text-blue-800 hidden sm:block">New to Tracklist? Here's how to get the most out of your album rating experience.</p>
                <button onclick="toggleMobileGuide()" class="sm:hidden text-blue-600 text-sm font-medium">
                    <span id="guide-toggle-text">Show steps</span>
                    <svg id="guide-toggle-icon" class="inline-block w-4 h-4 ml-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <button @click="dismissed = true; localStorage.setItem('guide-dismissed', 'true')" 
                    class="text-blue-400 hover:text-blue-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div id="guide-steps" class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-6 mobile-collapsible sm:!max-height-none sm:!overflow-visible">
            <div class="flex items-start space-x-2 md:space-x-3">
                <div class="flex-shrink-0 w-6 h-6 md:w-8 md:h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs md:text-sm font-semibold">1</div>
                <div>
                    <h4 class="font-medium text-blue-900 mb-0.5 md:mb-1 text-sm md:text-base">Search for Albums</h4>
                    <p class="text-xs md:text-sm text-blue-800">Find albums from MusicBrainz database</p>
                </div>
            </div>
            
            <div class="flex items-start space-x-2 md:space-x-3">
                <div class="flex-shrink-0 w-6 h-6 md:w-8 md:h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs md:text-sm font-semibold">2</div>
                <div>
                    <h4 class="font-medium text-blue-900 mb-0.5 md:mb-1 text-sm md:text-base">Rate Track by Track</h4>
                    <p class="text-xs md:text-sm text-blue-800">Use 4-point scale for each track</p>
                </div>
            </div>
            
            <div class="flex items-start space-x-2 md:space-x-3">
                <div class="flex-shrink-0 w-6 h-6 md:w-8 md:h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs md:text-sm font-semibold">3</div>
                <div>
                    <h4 class="font-medium text-blue-900 mb-0.5 md:mb-1 text-sm md:text-base">Get Your Score</h4>
                    <p class="text-xs md:text-sm text-blue-800">Get calculated album score out of 100</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rating Scale Reference -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 md:p-6 mx-4 md:mx-0">
        <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-3 md:mb-4">🎵 Rating Scale</h3>
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 md:gap-4 mobile-rating-grid">
            <div class="flex items-center space-x-2 md:space-x-3 p-2 md:p-3 bg-red-50 rounded-lg border border-red-100 mobile-rating-item">
                <div class="w-7 h-7 md:w-8 md:h-8 bg-rating-skip rounded flex items-center justify-center text-white text-xs md:text-sm font-bold rating-icon">0</div>
                <div>
                    <div class="font-medium text-red-800 text-sm md:text-base rating-label">Skip</div>
                    <div class="text-xs text-red-600 hidden sm:block rating-desc">Never hear</div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-3 p-2 md:p-3 bg-amber-50 rounded-lg border border-amber-100 mobile-rating-item">
                <div class="w-7 h-7 md:w-8 md:h-8 bg-rating-filler rounded flex items-center justify-center text-white text-xs md:text-sm font-bold rating-icon">⅓</div>
                <div>
                    <div class="font-medium text-amber-800 text-sm md:text-base rating-label">Filler</div>
                    <div class="text-xs text-amber-600 hidden sm:block rating-desc">Won't skip</div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-3 p-2 md:p-3 bg-green-50 rounded-lg border border-green-100 mobile-rating-item">
                <div class="w-7 h-7 md:w-8 md:h-8 bg-rating-good rounded flex items-center justify-center text-white text-xs md:text-sm font-bold rating-icon">⅔</div>
                <div>
                    <div class="font-medium text-green-800 text-sm md:text-base rating-label">Good</div>
                    <div class="text-xs text-green-600 hidden sm:block rating-desc">Playlist</div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-3 p-2 md:p-3 bg-green-100 rounded-lg border border-green-200 mobile-rating-item">
                <div class="w-7 h-7 md:w-8 md:h-8 bg-rating-standout rounded flex items-center justify-center text-white text-xs md:text-sm font-bold rating-icon">1</div>
                <div>
                    <div class="font-medium text-green-900 text-sm md:text-base rating-label">Standout</div>
                    <div class="text-xs text-green-700 hidden sm:block rating-desc">Highlights</div>
                </div>
            </div>
        </div>
        
        <div class="mt-3 md:mt-4 p-2 md:p-3 bg-blue-50 rounded-lg border border-blue-100">
            <details class="group">
                <summary class="flex items-center space-x-2 cursor-pointer select-none">
                    <svg class="w-3 h-3 md:w-4 md:h-4 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs md:text-sm text-blue-800 font-medium">Score Formula</span>
                    <svg class="w-3 h-3 ml-auto transform transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </summary>
                <div class="mt-2 text-xs md:text-sm text-blue-800 pl-5 md:pl-6">
                    Floor((Average × 10) + Bonus) × 10
                    <br>
                    <span class="text-xs">Album bonus: +0.33 (configurable)</span>
                </div>
            </details>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load user stats and recent activity -->
<script>
// Mobile guide toggle function
function toggleMobileGuide() {
    const steps = document.getElementById('guide-steps');
    const toggleText = document.getElementById('guide-toggle-text');
    const toggleIcon = document.getElementById('guide-toggle-icon');
    
    if (steps.classList.contains('expanded')) {
        steps.classList.remove('expanded');
        toggleText.textContent = 'Show steps';
        toggleIcon.classList.remove('rotate-180');
    } else {
        steps.classList.add('expanded');
        toggleText.textContent = 'Hide steps';
        toggleIcon.classList.add('rotate-180');
    }
}

// Score color utility function
function getScoreColorClass(score) {
    console.log('getScoreColorClass called with:', score, typeof score);
    
    if (score === null || score === undefined) {
        console.log('Score is null/undefined, returning empty string');
        return '';
    }
    
    // Convert to number to ensure proper comparison
    const numScore = Number(score);
    console.log('Converted score to number:', numScore);
    
    if (numScore === 100) {
        console.log('Returning dark green for score 100');
        return 'score-dark-green'; // Perfect score
    } else if (numScore >= 67) {
        console.log('Returning light green for score >= 67');
        return 'score-light-green'; // Good range
    } else if (numScore >= 33) {
        console.log('Returning orange for score >= 33');
        return 'score-orange'; // Filler range
    } else {
        console.log('Returning red for score < 33');
        return 'score-red'; // Skip range
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Load user statistics (removed since user-stats element doesn't exist in the page)
    // This was causing the HTMX error - commenting out for now
    /*
    // If you want to add user stats, create a proper element for it and use fetch instead:
    fetch('/api/v1/albums?limit=1')
        .then(response => response.json())
        .then(data => {
            const userStatsEl = document.getElementById('user-stats');
            if (userStatsEl) {
                userStatsEl.innerHTML = `
                    <div class="text-sm space-y-1">
                        <div><span class="font-medium">${data.total || 0}</span> albums total</div>
                        <div><span class="font-medium">${data.albums ? data.albums.filter(a => a.is_rated).length : 0}</span> completed</div>
                        <div><span class="font-medium">${data.albums ? data.albums.filter(a => !a.is_rated).length : 0}</span> in progress</div>
                    </div>
                `;
            }
        })
        .catch(error => console.error('Error loading user stats:', error));
    */
});

// Handle HTMX responses for album sections
document.body.addEventListener('htmx:afterRequest', function(evt) {
    const targetId = evt.detail.target.id;
    
    // Check if the request was successful
    if (evt.detail.xhr.status !== 200) {
        console.error(`HTMX request failed for ${targetId}:`, evt.detail.xhr.status, evt.detail.xhr.statusText);
        return;
    }
    
    if (targetId === 'in-progress-albums') {
        try {
            const response = JSON.parse(evt.detail.xhr.responseText);
            renderAlbumSection(response, 'in-progress-albums', 'in-progress');
            
            // Hide loading indicator
            const loadingEl = document.getElementById('in-progress-loading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
            
            // Hide section if no in-progress albums
            const section = document.getElementById('in-progress-section');
            if (response.albums && response.albums.length === 0) {
                section.style.display = 'none';
            }
        } catch (error) {
            console.error('Error parsing in-progress albums response:', error);
            console.error('Response text:', evt.detail.xhr.responseText);
        }
    } else if (targetId === 'recently-rated-albums') {
        try {
            const response = JSON.parse(evt.detail.xhr.responseText);
            renderAlbumSection(response, 'recently-rated-albums', 'recently-rated');
            
            // Hide loading indicator
            const loadingEl = document.getElementById('recently-rated-loading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
            
            // Show/hide Getting Started based on total album count
            checkAndShowGettingStarted();
        } catch (error) {
            console.error('Error parsing recently-rated albums response:', error);
            console.error('Response text:', evt.detail.xhr.responseText);
        }
    }
});

// Handle HTMX errors
document.body.addEventListener('htmx:responseError', function(evt) {
    console.error('HTMX response error:', evt.detail);
});

document.body.addEventListener('htmx:sendError', function(evt) {
    console.error('HTMX send error:', evt.detail);
});

function checkAndShowGettingStarted() {
    // Check if we have any albums at all
    const inProgressSection = document.getElementById('in-progress-section');
    const recentlyRatedSection = document.getElementById('recently-rated-section');
    const hasInProgress = inProgressSection && inProgressSection.style.display !== 'none';
    const hasRecentlyRated = recentlyRatedSection && recentlyRatedSection.querySelector('.grid');
    
    const gettingStartedGuide = document.getElementById('getting-started-guide');
    if (gettingStartedGuide) {
        if (!hasInProgress && !hasRecentlyRated && localStorage.getItem('guide-dismissed') !== 'true') {
            gettingStartedGuide.style.display = 'block';
        } else {
            gettingStartedGuide.style.display = 'none';
        }
    }
}

function renderAlbumSection(data, containerId, sectionType) {
    const container = document.getElementById(containerId);
    const albums = data.albums || [];
    const isMobile = window.innerWidth <= 640;
    const albumLimit = isMobile ? 3 : 6;
    
    // Show only limited albums on mobile
    const displayAlbums = albums.slice(0, albumLimit);
    
    if (albums.length === 0) {
        if (sectionType === 'recently-rated') {
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="max-w-sm mx-auto">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No recently rated albums</h3>
                        <p class="text-gray-600 mb-6">Complete rating some albums to see them here</p>
                        <a href="/search" 
                           class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Search Albums
                        </a>
                    </div>
                </div>
            `;
        } else {
            // For in-progress section, we'll hide it entirely if empty (handled in event listener)
            container.innerHTML = '';
        }
        return;
    }
    
    // Generate album cards with mobile-optimized layout
    const albumCards = displayAlbums.map(album => {
        // Mobile layout (compact horizontal card - clickable)
        if (isMobile) {
            const url = album.is_rated ? `/albums/${album.id}/completed` : `/albums/${album.id}/rate`;
            return `
        <a href="${url}" class="block bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-gray-300 transition-all duration-200 active:scale-[0.98]">
            <div class="flex items-center p-3">
                <!-- Compact Album Art -->
                ${album.cover_art_url ? `
                    <div class="w-12 h-12 rounded-lg overflow-hidden flex-shrink-0">
                        <img src="${album.cover_art_url}" 
                             alt="${album.title} cover" 
                             class="w-full h-full object-cover"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-12 h-12 bg-gradient-to-br from-gray-200 to-gray-300 rounded-lg flex items-center justify-center" style="display:none;">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                        </div>
                    </div>
                ` : `
                    <div class="w-12 h-12 bg-gradient-to-br from-gray-200 to-gray-300 rounded-lg flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                    </div>
                `}
                
                <!-- Album Info -->
                <div class="flex-1 min-w-0 ml-3">
                    <h3 class="font-semibold text-gray-900 text-sm truncate" title="${album.title}">${album.title}</h3>
                    <p class="text-xs text-gray-600 truncate mb-1" title="${album.artist}">${album.artist}</p>
                    
                    <!-- Status -->
                    <div class="flex items-center">
                        ${album.is_rated ? `
                            <span class="text-xs font-medium text-green-700">✓ Completed</span>
                            <span class="text-sm font-bold ${getScoreColorClass(album.rating_score)} ml-auto mr-2">${album.rating_score}/100</span>
                        ` : `
                            <span class="text-xs font-medium text-amber-700">⏳ In Progress</span>
                        `}
                    </div>
                </div>
                
                <!-- Arrow indicator -->
                <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </div>
        </a>
            `;
        }
        
        // Desktop layout (matching My Albums page style)
        const url = album.is_rated ? `/albums/${album.id}/completed` : `/albums/${album.id}/rate`;
        return `
        <a href="${url}" class="block bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-gray-300 transition-all duration-200 hover:-translate-y-1">
            <div class="p-4">
                <div class="flex space-x-3 mb-3">
                    <!-- Album Art -->
                    ${album.cover_art_url ? `
                        <div class="w-12 h-12 rounded-lg overflow-hidden flex-shrink-0">
                            <img src="${album.cover_art_url}" 
                                 alt="${album.title} cover" 
                                 class="w-full h-full object-cover"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="w-12 h-12 bg-gradient-to-br from-gray-200 to-gray-300 rounded-lg flex items-center justify-center" style="display:none;">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                </svg>
                            </div>
                        </div>
                    ` : `
                        <div class="w-12 h-12 bg-gradient-to-br from-gray-200 to-gray-300 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                        </div>
                    `}
                    
                    <!-- Album Info -->
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold text-gray-900 truncate" title="${album.title}">${album.title}</h3>
                        <p class="text-sm text-gray-600 truncate" title="${album.artist}">${album.artist}</p>
                        ${album.year ? `<p class="text-xs text-gray-500">${album.year}</p>` : ''}
                    </div>
                </div>
                
                <!-- Status and Score -->
                <div>
                    ${album.is_rated ? `
                        <div class="flex items-center justify-between">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ✓ Completed
                            </span>
                            <span class="text-lg font-bold ${getScoreColorClass(album.rating_score)}">${album.rating_score}/100</span>
                        </div>
                    ` : `
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                            ⏳ In Progress
                        </span>
                    `}
                </div>
            </div>
        </a>
    `;
    }).join('');
    
    // Add 'Show more' button on mobile if there are more albums
    const showMoreButton = (isMobile && albums.length > albumLimit) ? `
        <div class="mt-4 text-center">
            <button onclick="loadMoreAlbums('${containerId}', '${sectionType}')" 
                    class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                Show ${albums.length - albumLimit} more →
            </button>
        </div>
    ` : '';
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6">
            ${albumCards}
        </div>
        ${showMoreButton}
    `;
}

// Load more albums function
function loadMoreAlbums(containerId, sectionType) {
    const url = sectionType === 'in-progress' 
        ? '/api/v1/albums?limit=20&rated=false&sort=created_desc'
        : '/api/v1/albums?limit=20&rated=true&sort=rated_desc';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Re-render with all albums
            renderAlbumSection(data, containerId, sectionType);
        })
        .catch(error => console.error('Error loading more albums:', error));
}
</script>
{% endblock %}